"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=require("../../v-x-e-table"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_event=require("../../tools/event");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,n=1,l=arguments.length;n<l;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},tableMenuMethodKeys=["closeMenu"],tableMenuHook={setupTable:function(_){function m(t,e,n){var v,f=C.ctxMenuStore,l=i.value,o=R.value,e=o[e],g=o.visibleMethod;e&&(v=e.options,e.disabled?t.preventDefault():l&&v&&v.length&&(n.options=v,_.preventEvent(t,"event.showMenu",n,function(){var o,i,u,r,s,a,l,e,c,d;!g||g(n)?(t.preventDefault(),_.updateZindex(),e=(0,_dom.getDomNode)(),o=e.scrollTop,i=e.scrollLeft,u=e.visibleHeight,r=e.visibleWidth,s=t.clientY+o,a=t.clientX+i,l=function(){y._currMenuParams=n,Object.assign(f,{visible:!0,list:v,selected:null,selectChild:null,showChild:!1,style:{zIndex:y.tZindex,top:"".concat(s,"px"),left:"".concat(a,"px")}}),(0,_vue.nextTick)(function(){var e=N.value.getRefMaps().refElem.value,t=e.clientHeight,n=e.clientWidth,e=(0,_dom.getAbsolutePos)(e),l=e.boundingTop,e=e.boundingLeft+n-r;-10<l+t-u&&(f.style.top="".concat(Math.max(o+2,s-t-2),"px")),-10<e&&(f.style.left="".concat(Math.max(i+2,a-n-2),"px"))})},e=n.keyboard,c=n.row,d=n.column,e&&c&&d?_.scrollToRow(c,d).then(function(){var e,t,n=_.getCell(c,d);n&&(e=(t=(0,_dom.getAbsolutePos)(n)).boundingTop,t=t.boundingLeft,s=e+o+Math.floor(n.offsetHeight/2),a=t+i+Math.floor(n.offsetWidth/2)),l()}):l()):x.closeMenu()}))),_.closeFilter()}var x,M=_.xID,E=_.props,C=_.reactData,y=_.internalData,e=_.getRefMaps(),T=e.refElem,w=e.refTableFilter,N=e.refTableMenu,e=_.getComputeMaps(),O=e.computeMouseOpts,i=e.computeIsMenu,R=e.computeMenuOpts,c={},c={moveCtxMenu:function(e,t,n,l,o,i){var u,r=_xeUtils.default.findIndexOf(i,function(e){return t[n]===e});if(l)o&&(0,_utils.hasChildrenList)(t.selected)?t.showChild=!0:(t.showChild=!1,t.selectChild=null);else if((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_UP)){for(var s=r-1;0<=s;s--)if(!1!==i[s].visible){u=i[s];break}t[n]=u||i[i.length-1]}else if((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_DOWN)){for(var a=r+1;a<i.length;a++)if(!1!==i[a].visible){u=i[a];break}t[n]=u||i[0]}else t[n]&&((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ENTER)||(0,_event.hasEventKey)(e,_event.EVENT_KEYS.SPACEBAR))&&c.ctxMenuLinkEvent(e,t[n])},handleGlobalContextmenuEvent:function(e){var t=E.mouseConfig,n=E.menuConfig,l=C.editStore,o=C.ctxMenuStore,i=y.visibleColumn,u=w.value,r=N.value,s=O.value,a=R.value,c=T.value,l=l.selected,d=["header","body","footer"];if((0,_utils.isEnableConf)(n)){if(o.visible&&r&&(0,_dom.getEventTargetNode)(e,r.getRefMaps().refElem.value).flag)return void e.preventDefault();if(y._keyCtx){var n="body",v={type:n,$table:_,keyboard:!0,columns:i.slice(0),$event:e};if(t&&s.area){o=_.getActiveCellArea();if(o&&o.row&&o.column)return v.row=o.row,v.column=o.column,void m(e,n,v)}else if(t&&s.selected&&l.row&&l.column)return v.row=l.row,v.column=l.column,void m(e,n,v)}for(var f=0;f<d.length;f++){var g,h,b=d[f],p=(0,_dom.getEventTargetNode)(e,c,"vxe-".concat(b,"--column"),function(e){return e.parentNode.parentNode.parentNode.getAttribute("xid")===M}),v={type:b,$table:_,columns:i.slice(0),$event:e};if(p.flag)return p=p.targetElem,h=(h=_.getColumnNode(p))?h.item:null,g="".concat(b,"-"),h&&Object.assign(v,{column:h,columnIndex:_.getColumnIndex(h),cell:p}),"body"===b&&(g="",p=(h=_.getRowNode(p.parentNode))?h.item:null)&&(v.row=p,v.rowIndex=_.getRowIndex(p)),h="".concat(g,"cell-menu"),m(e,b,v),void _.dispatchEvent(h,v,e);if((0,_dom.getEventTargetNode)(e,c,"vxe-table--".concat(b,"-wrapper"),function(e){return e.getAttribute("xid")===M}).flag)return void("cell"===a.trigger?e.preventDefault():m(e,b,v))}}u&&!(0,_dom.getEventTargetNode)(e,u.$el).flag&&_.closeFilter(),x.closeMenu()},ctxMenuMouseoverEvent:function(e,t,n){var r=e.currentTarget,l=C.ctxMenuStore;e.preventDefault(),e.stopPropagation(),l.selected=t,(l.selectChild=n)||(l.showChild=(0,_utils.hasChildrenList)(t),l.showChild&&(0,_vue.nextTick)(function(){var e,t,n,l,o,i,u=r.nextElementSibling;u&&(t=(i=(0,_dom.getAbsolutePos)(r)).boundingTop,o=i.boundingLeft,e=i.visibleHeight,i=i.visibleWidth,t=t+r.offsetHeight,l=n="",o+r.offsetWidth+u.offsetWidth>i-10&&(n="auto",l="".concat(r.offsetWidth,"px")),i=o="",t+u.offsetHeight>e-10&&(o="auto",i="0"),u.style.left=n,u.style.right=l,u.style.top=o,u.style.bottom=i)}))},ctxMenuMouseoutEvent:function(e,t){var n=C.ctxMenuStore;t.children||(n.selected=null),n.selectChild=null},ctxMenuLinkEvent:function(e,t){var n;t.disabled||!t.code&&t.children&&t.children.length||(n=_vXETable.VXETable.menus.get(t.code),t=Object.assign({},y._currMenuParams,{menu:t,$table:_,$grid:_.xegrid,$event:e}),n&&n(t,e),_.dispatchEvent("menu-click",t,e),x.closeMenu())}};return __assign(__assign({},x={closeMenu:function(){return Object.assign(C.ctxMenuStore,{visible:!1,selected:null,selectChild:null,showChild:!1}),(0,_vue.nextTick)()}}),c)},setupGrid:function(e){return e.extendTableMethods(tableMenuMethodKeys)}},_default=tableMenuHook;exports.default=_default;