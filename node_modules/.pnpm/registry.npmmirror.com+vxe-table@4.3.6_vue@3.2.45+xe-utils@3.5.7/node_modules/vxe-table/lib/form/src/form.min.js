"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=require("../../v-x-e-table"),_utils=require("../../tools/utils"),_log=require("../../tools/log"),_dom=require("../../tools/dom"),_util=require("./util"),_size=require("../../hooks/size"),_formConfigItem=_interopRequireDefault(require("./form-config-item")),_index=_interopRequireDefault(require("../../loading/index")),_vn=require("../../tools/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},Rule=function(){function e(e){Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return Object.defineProperty(e.prototype,"content",{get:function(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"message",{get:function(){return this.content},enumerable:!1,configurable:!0}),e}(),validErrorRuleValue=function(e,t){var n=e.type,r=e.min,i=e.max,e=e.pattern,n="number"===n,u=n?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!n||!isNaN(t))||!_xeUtils.default.eqNull(r)&&u<_xeUtils.default.toNumber(r)||!_xeUtils.default.eqNull(i)&&u>_xeUtils.default.toNumber(i)||!(!e||(_xeUtils.default.isRegExp(e)?e:new RegExp(e)).test(t))};function getResetValue(e,t){return t=_xeUtils.default.isArray(e)?[]:t}var _default=(0,_vue.defineComponent)({name:"VxeForm",props:{collapseStatus:{type:Boolean,default:!0},loading:Boolean,data:Object,size:{type:String,default:function(){return _conf.default.form.size||_conf.default.size}},span:{type:[String,Number],default:function(){return _conf.default.form.span}},align:{type:String,default:function(){return _conf.default.form.align}},titleAlign:{type:String,default:function(){return _conf.default.form.titleAlign}},titleWidth:{type:[String,Number],default:function(){return _conf.default.form.titleWidth}},titleColon:{type:Boolean,default:function(){return _conf.default.form.titleColon}},titleAsterisk:{type:Boolean,default:function(){return _conf.default.form.titleAsterisk}},titleOverflow:{type:[Boolean,String],default:null},className:[String,Function],readonly:Boolean,items:Array,rules:Object,preventSubmit:{type:Boolean,default:function(){return _conf.default.form.preventSubmit}},validConfig:Object,tooltipConfig:Object,customLayout:{type:Boolean,default:function(){return _conf.default.form.customLayout}}},emits:["update:collapseStatus","collapse","toggle-collapse","submit","submit-invalid","reset"],setup:function(d,e){function t(e){e.length&&("development"===process.env.NODE_ENV&&e.forEach(function(e){e.slots&&_xeUtils.default.each(e.slots,function(e){_xeUtils.default.isFunction(e)||m[e]||(0,_log.errLog)("vxe.error.notSlot",[e])})}),p.staticItems=_xeUtils.default.mapTree(e,function(e){return(0,_util.createItem)(S,e)},{children:"children"})),(0,_vue.nextTick)()}function n(){return p.collapseAll}function r(){var e=!n();return p.collapseAll=e,u("update:collapseStatus",e),(0,_vue.nextTick)()}function a(e){e.preventDefault(),O(),x.dispatchEvent("reset",{data:d.data},e)}function s(t){t.preventDefault(),d.preventSubmit||(q(),V(R()).then(function(e){e?x.dispatchEvent("submit-invalid",{data:d.data,errMap:e},t):x.dispatchEvent("submit",{data:d.data},t)}))}function o(){var e=_.tooltipStore,t=h.value;return e.visible&&(Object.assign(e,{item:null,visible:!1}),t)&&t.close(),(0,_vue.nextTick)()}function i(e,n,t){return n?C(e?["blur"].includes(e.type)?"blur":"change":"all",n,t).then(function(){q(n)}).catch(function(e){var e=e.rule,t=U(n);t&&(t.showError=!0,t.errRule=e)}):(0,_vue.nextTick)()}var c,f=_vXETable.VXETable.tooltip,m=e.slots,u=e.emit,l=_xeUtils.default.uniqueId(),v=(0,_size.useSize)(d),p=(0,_vue.reactive)({collapseAll:d.collapseStatus,staticItems:[],formItems:[]}),_=(0,_vue.reactive)({tooltipTimeout:null,tooltipStore:{item:null,visible:!1}}),g=(0,_vue.ref)(),h=(0,_vue.ref)(),x={},b=(0,_vue.computed)(function(){return Object.assign({},_conf.default.form.validConfig,d.validConfig)}),y=(0,_vue.computed)(function(){return Object.assign({},_conf.default.tooltip,_conf.default.form.tooltipConfig,d.tooltipConfig)}),E={refElem:g},T={computeSize:v,computeValidOpts:b,computeTooltipOpts:y},S={xID:l,props:d,context:e,reactData:p,getRefMaps:function(){return E},getComputeMaps:function(){return T}},R=function(){var t=[];return _xeUtils.default.eachTree(p.formItems,function(e){t.push(e)},{children:"children"}),t},U=function(t){var e=_xeUtils.default.findTree(p.formItems,function(e){return e.field===t},{children:"children"});return e?e.item:null},q=function(e){return e?(e=(0,_util.handleFieldOrItem)(S,e))&&(e.showError=!1):R().forEach(function(e){e.showError=!1}),(0,_vue.nextTick)()},O=function(){var i=d.data,e=R();return i&&e.forEach(function(e){var t=e.field,n=e.resetValue,r=e.itemRender;(0,_utils.isEnableConf)(r)&&((r=_vXETable.VXETable.renderer.get(r.name))&&r.itemResetMethod?r.itemResetMethod({data:i,field:t,property:t,item:e,$form:S}):t&&_xeUtils.default.set(i,t,null===n?getResetValue(_xeUtils.default.get(i,t),void 0):_xeUtils.default.clone(n,!0)))}),q()},w=function(e){for(var t=g.value,n=0;n<e.length;n++){var r=e[n],r=U(r);if(r&&(0,_utils.isEnableConf)(r.itemRender)){var i=r.itemRender,u=_vXETable.VXETable.renderer.get(i.name),o=null;if(n||(0,_dom.scrollToView)(t.querySelector(".".concat(r.id))),o=!(o=i.autofocus?t.querySelector(".".concat(r.id," ").concat(i.autofocus)):o)&&u&&u.autofocus?t.querySelector(".".concat(r.id," ").concat(u.autofocus)):o){o.focus();break}}}},C=function(u,o,e){var l,a,s=d.data,t=d.rules,c=[],f=[];return o&&t&&(l=_xeUtils.default.get(t,o))&&(a=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(s,o):e,l.forEach(function(t){var e,n=t.type,r=t.trigger,i=t.required;"all"!==u&&r&&u!==r||(_xeUtils.default.isFunction(t.validator)?(e=t.validator({itemValue:a,rule:t,rules:l,data:s,field:o,property:o,$form:S}))&&(_xeUtils.default.isError(e)?c.push(new Rule({type:"custom",trigger:r,content:e.message,rule:new Rule(t)})):e.catch&&f.push(e.catch(function(e){c.push(new Rule({type:"custom",trigger:r,content:e?e.message:t.content||t.message,rule:new Rule(t)}))}))):(e="array"===n||_xeUtils.default.isArray(a)?!_xeUtils.default.isArray(a)||!a.length:(0,_utils.eqEmptyValue)(a),(i?e||validErrorRuleValue(t,a):!e&&validErrorRuleValue(t,a))&&c.push(new Rule(t))))})),Promise.all(f).then(function(){if(c.length)return Promise.reject({rules:c,rule:c[0]})})},V=function(t,e,n){var i=d.data,r=d.rules,u=b.value,o={},l=[],a=[];return clearTimeout(c),i&&r?(t.forEach(function(n){var r=n.field;r&&!(0,_util.isHiddenItem)(S,n)&&(0,_util.isActivetem)(S,n)&&a.push(C(e||"all",r).then(function(){n.errRule=null}).catch(function(e){var t=e.rule,e={rule:t,rules:e.rules,data:i,field:r,property:r,$form:S};return o[r]||(o[r]=[]),o[r].push(e),l.push(r),n.errRule=t,Promise.reject(e)}))}),Promise.all(a).then(function(){n&&n()}).catch(function(){return new Promise(function(e){c=window.setTimeout(function(){t.forEach(function(e){e.errRule&&(e.showError=!0)})},20),!1!==u.autoPos&&(0,_vue.nextTick)(function(){w(l)}),n?(n(o),e()):e(o)})})):(n&&n(),Promise.resolve())},x={dispatchEvent:function(e,t,n){u(e,Object.assign({$form:S,$event:n},t))},reset:O,validate:function(e){return q(),V(R(),"",e)},validateField:function(e,t){e=(0,_util.handleFieldOrItem)(S,e);return V(e?[e]:[],"",t)},clearValidate:q,updateStatus:function(e,t){e=e.field;return i(new Event("change"),e,t)},toggleCollapse:r,getItems:R,getItemByField:U,closeTooltip:o};Object.assign(S,x,{callSlot:function(e,t){return e&&(_xeUtils.default.isString(e)&&(e=m[e]||null),_xeUtils.default.isFunction(e))?(0,_vn.getSlotVNs)(e(t)):[]},triggerItemEvent:i,toggleCollapseEvent:function(e){r();var t=n();x.dispatchEvent("toggle-collapse",{status:t,collapse:t,data:d.data},e),x.dispatchEvent("collapse",{status:t,collapse:t,data:d.data},e)},triggerTitleTipEvent:function(e,t){var t=t.item,n=_.tooltipStore,r=h.value,e=e.currentTarget.children[0],i=(e.textContent||"").trim(),u=e.scrollWidth>e.clientWidth;clearTimeout(_.tooltipTimeout),n.item!==t&&o(),i&&u&&(Object.assign(n,{item:t,visible:!0}),r)&&r.open(e,i)},handleTitleTipLeaveEvent:function(){var e=y.value,t=h.value;t&&t.setActived(!1),e.enterable?_.tooltipTimeout=setTimeout(function(){(t=h.value)&&!t.isActived()&&o()},e.leaveDelay):o()}}),(0,_vue.watch)(function(){return p.staticItems},function(e){p.formItems=e}),(0,_vue.watch)(function(){return d.items},function(e){t(e||[])}),(0,_vue.watch)(function(){return d.collapseStatus},function(e){p.collapseAll=!!e}),(0,_vue.onMounted)(function(){(0,_vue.nextTick)(function(){"development"===process.env.NODE_ENV&&d.customLayout&&d.items&&(0,_log.errLog)("vxe.error.errConflicts",["custom-layout","items"]),t(d.items||[])})});return S.renderVN=function(){var e=d.loading,t=d.className,n=d.data,r=d.customLayout,i=p.formItems,u=v.value,o=y.value,l=m.default;return(0,_vue.h)("form",{ref:g,class:["vxe-form",t?_xeUtils.default.isFunction(t)?t({items:i,data:n,$form:S}):t:"",((n={})["size--".concat(u)]=u,n["is--loading"]=e,n)],onSubmit:s,onReset:a},[(0,_vue.h)("div",{class:"vxe-form--wrapper vxe-row"},r?l?l({}):[]:i.map(function(e,t){return(0,_vue.h)(_formConfigItem.default,{key:t,itemConfig2:e,itemConfig:e})})),(0,_vue.h)("div",{class:"vxe-form-slots",ref:"hideItem"},!r&&l?l({}):[]),(0,_vue.h)(_index.default,{class:"vxe-form--loading",modelValue:e}),f?(0,_vue.h)((0,_vue.resolveComponent)("vxe-tooltip"),__assign({ref:h},o)):(0,_vue.createCommentVNode)()])},(0,_vue.provide)("$xeform",S),(0,_vue.provide)("$xeformgather",null),(0,_vue.provide)("$xeformitem",null),(0,_vue.provide)("$xeformiteminfo",null),S},render:function(){return this.renderVN()}});exports.default=_default;