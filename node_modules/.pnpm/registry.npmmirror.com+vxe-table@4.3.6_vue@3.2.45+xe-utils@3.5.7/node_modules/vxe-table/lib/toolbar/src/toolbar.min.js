"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=require("../../v-x-e-table"),_size=require("../../hooks/size"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_log=require("../../tools/log"),_event=require("../../tools/event"),_vn=require("../../tools/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var i in t=arguments[o])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},_default=(0,_vue.defineComponent)({name:"VxeToolbar",props:{loading:Boolean,refresh:[Boolean,Object],import:[Boolean,Object],export:[Boolean,Object],print:[Boolean,Object],zoom:[Boolean,Object],custom:[Boolean,Object],buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},tools:{type:Array,default:function(){return _conf.default.toolbar.tools}},perfect:{type:Boolean,default:function(){return _conf.default.toolbar.perfect}},size:{type:String,default:function(){return _conf.default.toolbar.size||_conf.default.size}},className:[String,Function]},emits:["button-click","tool-click"],setup:function(m,e){function n(){var e=B.columns,t=C.getComputeMaps().computeCustomOpts.value.checkMethod;k.isAll=e.every(function(e){return!!t&&!t({column:e})||e.visible}),k.isIndeterminate=!k.isAll&&e.some(function(e){return(!t||t({column:e}))&&(e.visible||e.halfVisible)})}function i(){C.handleCustom()}function t(e){!v()||k.visible||(k.visible=!0,n(),d("open",e))}function o(e){k.visible&&(f(),d("close",e))}function l(t){var e=B.columns;(e=_xeUtils.default.findTree(e,function(e){return e===t}))&&e.parent&&(e=e.parent).children&&e.children.length&&(e.visible=e.children.every(function(e){return e.visible}),e.halfVisible=!e.visible&&e.children.some(function(e){return e.visible||e.halfVisible}),l(e))}function u(e){var t=R.value;(0,_dom.getEventTargetNode)(e,t).flag||o(e)}function r(e){o(e)}function p(){var e=B.isRefresh,t=A.value;if(!e){e=t.queryMethod||t.query;if(e){B.isRefresh=!0;try{Promise.resolve(e({})).catch(function(e){return e}).then(function(){B.isRefresh=!1})}catch(e){B.isRefresh=!1}}else M&&(B.isRefresh=!0,M.commitProxy(t.code||"reload").catch(function(e){return e}).then(function(){B.isRefresh=!1}))}}function h(e){M&&M.triggerZoomEvent(e)}function x(){v()&&C.openImport()}function g(){v()&&C.openExport()}function O(){v()&&C.openPrint()}var C,T=e.slots,c=e.emit,a=_xeUtils.default.uniqueId(),E=(0,_size.useSize)(m),B=(0,_vue.reactive)({isRefresh:!1,columns:[]}),y=(0,_vue.ref)(),R=(0,_vue.ref)(),k=(0,_vue.reactive)({isAll:!1,isIndeterminate:!1,activeBtn:!1,activeWrapper:!1,visible:!1}),s={refElem:y},L={xID:a,props:m,context:e,reactData:B,getRefMaps:function(){return s}},M=(0,_vue.inject)("$xegrid",null),A=(0,_vue.computed)(function(){return Object.assign({},_conf.default.toolbar.refresh,m.refresh)}),N=(0,_vue.computed)(function(){return Object.assign({},_conf.default.toolbar.import,m.import)}),V=(0,_vue.computed)(function(){return Object.assign({},_conf.default.toolbar.export,m.export)}),z=(0,_vue.computed)(function(){return Object.assign({},_conf.default.toolbar.print,m.print)}),$=(0,_vue.computed)(function(){return Object.assign({},_conf.default.toolbar.zoom,m.zoom)}),q=(0,_vue.computed)(function(){return Object.assign({},_conf.default.toolbar.custom,m.custom)}),v=function(){if(C)return!0;(0,_log.errLog)("vxe.error.barUnableLink")},f=function(){var e=m.custom,t=q.value;k.visible&&(k.visible=!1,e)&&!t.immediate&&i()},d=function(e,t){(M||C).dispatchEvent("custom",{type:e},t)},X=function(e){f(),d("confirm",e)},U=function(e){var t=B.columns,o=C.getComputeMaps().computeCustomOpts.value.checkMethod;_xeUtils.default.eachTree(t,function(e){o&&!o({column:e})||(e.visible=e.defaultVisible,e.halfVisible=!1),e.resizeWidth=0}),C.saveCustomResizable(!0),f(),d("reset",e)},w=function(e){var t=!e.visible,o=q.value;_xeUtils.default.eachTree([e],function(e){e.visible=t,e.halfVisible=!1}),l(e),m.custom&&o.immediate&&i(),n()},D=function(){var e=B.columns,t=C.getComputeMaps().computeCustomOpts.value.checkMethod,o=!k.isAll;_xeUtils.default.eachTree(e,function(e){t&&!t({column:e})||(e.visible=o,e.halfVisible=!1)}),k.isAll=o,n()},H=function(e){(k.visible?o:t)(e)},K=function(e){k.activeBtn=!0,t(e)},P=function(e){k.activeBtn=!1,setTimeout(function(){k.activeBtn||k.activeWrapper||o(e)},300)},F=function(e){k.activeWrapper=!0,t(e)},W=function(e){k.activeWrapper=!1,setTimeout(function(){k.activeBtn||k.activeWrapper||o(e)},300)},S=function(e,t){var o,n=t.code;n&&(M?M.triggerToolbarBtnEvent(t,e):(o=_vXETable.VXETable.commands.get(n),n={code:n,button:t,$table:C,$event:e},o&&o(n,e),L.dispatchEvent("button-click",n,e)))},j=function(e,t){var o,n=t.code;n&&(M?M.triggerToolbarTolEvent(t,e):(o=_vXETable.VXETable.commands.get(n),n={code:n,tool:t,$table:C,$event:e},o&&o(n,e),L.dispatchEvent("tool-click",n,e)))},I=function(e,o){e=e.dropdowns;return e?e.map(function(t,e){return!1===t.visible?(0,_vue.createCommentVNode)():(0,_vue.h)((0,_vue.resolveComponent)("vxe-button"),{key:e,disabled:t.disabled,loading:t.loading,type:t.type,icon:t.icon,circle:t.circle,round:t.round,status:t.status,content:t.name,onClick:function(e){return(o?S:j)(e,t)}})}):[]};Object.assign(L,{dispatchEvent:function(e,t,o){c(e,Object.assign({$toolbar:L,$event:o},t))},syncUpdate:function(e){var t=e.collectColumn;C=e.$table,B.columns=t}}),(0,_vue.onMounted)(function(){_event.GlobalEvent.on(L,"mousedown",u),_event.GlobalEvent.on(L,"blur",r)}),(0,_vue.onUnmounted)(function(){_event.GlobalEvent.off(L,"mousedown"),_event.GlobalEvent.off(L,"blur")}),(0,_vue.nextTick)(function(){var e=m.refresh,t=A.value,t=t.queryMethod||t.query;!e||M||t||(0,_log.warnLog)("vxe.error.notFunc",["queryMethod"])});return L.renderVN=function(){var u,r,i,l,e=m.perfect,t=m.loading,o=m.refresh,n=m.zoom,c=m.custom,a=m.className,s=E.value,v=A.value,f=N.value,d=V.value,_=z.value,b=$.value;return(0,_vue.h)("div",{ref:y,class:["vxe-toolbar",a?_xeUtils.default.isFunction(a)?a({$toolbar:L}):a:"",((a={})["size--".concat(s)]=s,a["is--perfect"]=e,a["is--loading"]=t,a)]},[(0,_vue.h)("div",{class:"vxe-buttons--wrapper"},(s=m.buttons,(e=T.buttons)?(0,_vn.getSlotVNs)(e({$grid:M,$table:C})):(l=[],s&&s.forEach(function(t){var e,o=t.dropdowns,n=t.buttonRender;!1!==t.visible&&(e=n?_vXETable.VXETable.renderer.get(n.name):null,n&&e&&e.renderToolbarButton?l.push((0,_vue.h)("span",{class:"vxe-button--item"},(0,_vn.getSlotVNs)(e.renderToolbarButton(n,{$grid:M,$table:C,button:t})))):l.push((0,_vue.h)((0,_vue.resolveComponent)("vxe-button"),{disabled:t.disabled,loading:t.loading,type:t.type,icon:t.icon,circle:t.circle,round:t.round,status:t.status,content:t.name,destroyOnClose:t.destroyOnClose,placement:t.placement,transfer:t.transfer,onClick:function(e){return S(e,t)}},o&&o.length?{dropdowns:function(){return I(t,!0)}}:{})))}),l))),(0,_vue.h)("div",{class:"vxe-tools--wrapper"},(t=m.tools,(a=T.tools)?(0,_vn.getSlotVNs)(a({$grid:M,$table:C})):(i=[],t&&t.forEach(function(t){var e,o=t.dropdowns,n=t.toolRender;!1!==t.visible&&(e=n?_vXETable.VXETable.renderer.get(n.name):null,n&&e&&e.renderToolbarTool?i.push((0,_vue.h)("span",{class:"vxe-tool--item"},(0,_vn.getSlotVNs)(e.renderToolbarTool(n,{$grid:M,$table:C,tool:t})))):i.push((0,_vue.h)((0,_vue.resolveComponent)("vxe-button"),{disabled:t.disabled,loading:t.loading,type:t.type,icon:t.icon,circle:t.circle,round:t.round,status:t.status,content:t.name,destroyOnClose:t.destroyOnClose,placement:t.placement,transfer:t.transfer,onClick:function(e){return j(e,t)}},o&&o.length?{dropdowns:function(){return I(t,!1)}}:{})))}),i))),(0,_vue.h)("div",{class:"vxe-tools--operate"},[m.import?(0,_vue.h)((0,_vue.resolveComponent)("vxe-button"),{circle:!0,icon:f.icon||_conf.default.icon.TOOLBAR_TOOLS_IMPORT,title:_conf.default.i18n("vxe.toolbar.import"),onClick:x}):(0,_vue.createCommentVNode)(),m.export?(0,_vue.h)((0,_vue.resolveComponent)("vxe-button"),{circle:!0,icon:d.icon||_conf.default.icon.TOOLBAR_TOOLS_EXPORT,title:_conf.default.i18n("vxe.toolbar.export"),onClick:g}):(0,_vue.createCommentVNode)(),m.print?(0,_vue.h)((0,_vue.resolveComponent)("vxe-button"),{circle:!0,icon:_.icon||_conf.default.icon.TOOLBAR_TOOLS_PRINT,title:_conf.default.i18n("vxe.toolbar.print"),onClick:O}):(0,_vue.createCommentVNode)(),o?(0,_vue.h)((0,_vue.resolveComponent)("vxe-button"),{circle:!0,icon:B.isRefresh?v.iconLoading||_conf.default.icon.TOOLBAR_TOOLS_REFRESH_LOADING:v.icon||_conf.default.icon.TOOLBAR_TOOLS_REFRESH,title:_conf.default.i18n("vxe.toolbar.refresh"),onClick:p}):(0,_vue.createCommentVNode)(),n&&M?(0,_vue.h)((0,_vue.resolveComponent)("vxe-button"),{circle:!0,icon:M.isMaximized()?b.iconOut||_conf.default.icon.TOOLBAR_TOOLS_MINIMIZE:b.iconIn||_conf.default.icon.TOOLBAR_TOOLS_FULLSCREEN,title:_conf.default.i18n("vxe.toolbar.zoom".concat(M.isMaximized()?"Out":"In")),onClick:h}):(0,_vue.createCommentVNode)(),c?(e=B.columns,s=q.value,r=[],a={},t={},C&&(u=C.getComputeMaps().computeCustomOpts.value.checkMethod),"manual"!==s.trigger&&("hover"===s.trigger?(a.onMouseenter=K,a.onMouseleave=P,t.onMouseenter=F,t.onMouseleave=W):a.onClick=H),_xeUtils.default.eachTree(e,function(e){var t,o=(0,_utils.formatText)(e.getTitle(),1),n=e.getKey(),i=e.children&&e.children.length,l=!!u&&!u({column:e});(i||n)&&(n=e.visible,t=e.halfVisible,r.push((0,_vue.h)("li",{class:["vxe-custom--option","level--".concat(e.level),{"is--group":i,"is--checked":n,"is--indeterminate":t,"is--disabled":l}],title:o,onClick:function(){l||w(e)}},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",t?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:n?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]}),(0,_vue.h)("span",{class:"vxe-checkbox--label"},o)])))}),e=k.isAll,f=k.isIndeterminate,(0,_vue.h)("div",{class:["vxe-custom--wrapper",{"is--active":k.visible}],ref:R},[(0,_vue.h)((0,_vue.resolveComponent)("vxe-button"),__assign({circle:!0,icon:s.icon||_conf.default.icon.TOOLBAR_TOOLS_CUSTOM,title:_conf.default.i18n("vxe.toolbar.custom")},a)),(0,_vue.h)("div",{class:"vxe-custom--option-wrapper"},[(0,_vue.h)("ul",{class:"vxe-custom--header"},[(0,_vue.h)("li",{class:["vxe-custom--option",{"is--checked":e,"is--indeterminate":f}],title:_conf.default.i18n("vxe.table.allTitle"),onClick:D},[(0,_vue.h)("span",{class:["vxe-checkbox--icon",f?_conf.default.icon.TABLE_CHECKBOX_INDETERMINATE:e?_conf.default.icon.TABLE_CHECKBOX_CHECKED:_conf.default.icon.TABLE_CHECKBOX_UNCHECKED]}),(0,_vue.h)("span",{class:"vxe-checkbox--label"},_conf.default.i18n("vxe.toolbar.customAll"))])]),(0,_vue.h)("ul",__assign({class:"vxe-custom--body"},t),r),!1===s.isFooter?null:(0,_vue.h)("div",{class:"vxe-custom--footer"},[(0,_vue.h)("button",{class:"btn--confirm",onClick:X},_conf.default.i18n("vxe.toolbar.customConfirm")),(0,_vue.h)("button",{class:"btn--reset",onClick:U},_conf.default.i18n("vxe.toolbar.customRestore"))])])])):(0,_vue.createCommentVNode)()])])},L},render:function(){return this.renderVN()}});exports.default=_default;