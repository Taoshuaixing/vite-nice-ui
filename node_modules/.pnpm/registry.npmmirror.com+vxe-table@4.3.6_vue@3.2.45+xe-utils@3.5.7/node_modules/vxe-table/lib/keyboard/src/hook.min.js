"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_dom=require("../../tools/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getTargetOffset(e,t){var o,l,n=0,r=0,c=!_dom.browse.firefox&&(0,_dom.hasClass)(e,"vxe-checkbox--label");for(c&&(o=getComputedStyle(e),n-=_xeUtils.default.toNumber(o.paddingTop),r-=_xeUtils.default.toNumber(o.paddingLeft));e&&e!==t;)n+=e.offsetTop,r+=e.offsetLeft,e=e.offsetParent,c&&(l=getComputedStyle(e),n-=_xeUtils.default.toNumber(l.paddingTop),r-=_xeUtils.default.toNumber(l.paddingLeft));return{offsetTop:n,offsetLeft:r}}var tableKeyboardHook={setupTable:function(y){var f=y.props,k=y.reactData,H=y.internalData,E=y.getRefMaps().refElem,e=y.getComputeMaps(),g=e.computeEditOpts,u=e.computeCheckboxOpts,i=e.computeMouseOpts,s=e.computeTreeOpts;function d(e,a){var t,u,i,s,d,o,l,f,g,m,h,n,p,v,x,c,w,b,T,C,R,_,I,r=a.column,M=a.cell;"checkbox"===r.type&&(t=E.value,n=H.elemStore,u=e.clientX,i=e.clientY,r=n["".concat(r.fixed||"main","-body-wrapper")]||n["main-body-wrapper"],s=r?r.value:null)&&(d=s.querySelector(".vxe-table--checkbox-range"),o=document.onmousemove,l=document.onmouseup,f=M.parentNode,g=y.getCheckboxRecords(),m=[],h=1,n=getTargetOffset(e.target,s),p=n.offsetTop+e.offsetY,v=n.offsetLeft+e.offsetX,x=s.scrollTop,c=f.offsetHeight,w=null,T=1,C=function(e,t){y.dispatchEvent("checkbox-range-".concat(e),{records:y.getCheckboxRecords(),reserves:y.getCheckboxReserveRecords()},t)},R=function(e){var t=e.clientX,o=e.clientY,t=t-u,o=o-i+(s.scrollTop-x),l=Math.abs(o),n=Math.abs(t),r=p,c=v,t=(o<h?(r+=o)<h&&(r=h,l=p):l=Math.min(l,s.scrollHeight-p-h),t<h?(c+=t,v<n&&(c=h,n=v)):n=Math.min(n,s.clientWidth-v-h),d.style.height="".concat(l,"px"),d.style.width="".concat(n,"px"),d.style.left="".concat(c,"px"),d.style.top="".concat(r,"px"),d.style.display="block",function(e,t,o){var l=0,n=[],r=0<o,c=0<o?o:Math.abs(o)+t.offsetHeight,o=k.scrollYLoad,a=H.afterFullData,u=H.scrollYStore;if(o)o=y.getVTRowIndex(e.row),n=r?a.slice(o,o+Math.ceil(c/u.rowHeight)):a.slice(o-Math.floor(c/u.rowHeight)+1,o+1);else for(var i=r?"next":"previous";t&&l<c;){var s=y.getRowNode(t);s&&(n.push(s.item),l+=t.offsetHeight,t=t["".concat(i,"ElementSibling")])}return n}(a,f,o<h?-l:l));10<l&&t.length!==m.length&&(m=t,e.ctrlKey?t.forEach(function(e){y.handleSelectRow({row:e},-1===g.indexOf(e))}):(y.setAllCheckboxRow(!1),y.setCheckboxRow(t,!0)),C("change",e))},_=function(){clearTimeout(w),w=null},(b=!(I=function(r){_(),w=setTimeout(function(){var e,t,o,l,n;w&&(e=s.scrollLeft,t=s.scrollTop,o=s.clientHeight,l=s.scrollHeight,n=Math.ceil(50*T/c),b?t+o<l?(y.scrollTo(e,t+n),I(r),R(r)):_():t?(y.scrollTo(e,t-n),I(r),R(r)):_())},50)}),_dom.addClass)(t,"drag--range"),document.onmousemove=function(e){e.preventDefault(),e.stopPropagation();var t=e.clientY,o=(0,_dom.getAbsolutePos)(s).boundingTop;t<o?(b=!1,T=o-t,w||I(e)):t>o+s.clientHeight?(b=!0,T=t-o-s.clientHeight,w||I(e)):w&&_(),R(e)},document.onmouseup=function(e){_(),(0,_dom.removeClass)(t,"drag--range"),d.removeAttribute("style"),document.onmousemove=o,document.onmouseup=l,C("end",e)},C("start",e))}return{moveTabSelected:function(e,t,o){var l,n,r,c=f.editConfig,a=H.afterFullData,u=H.visibleColumn,i=g.value,s=Object.assign({},e),e=y.getVTRowIndex(s.row),d=y.getVTColumnIndex(s.column),t=(o.preventDefault(),t?d<=0?0<e&&(l=a[n=e-1],r=u.length-1):r=d-1:d>=u.length-1?e<a.length-1&&(l=a[n=e+1],r=0):r=d+1,u[r]);t&&(l?(s.rowIndex=n,s.row=l):s.rowIndex=e,s.columnIndex=r,s.column=t,s.cell=y.getCell(s.row,s.column),c?"click"!==i.trigger&&"dblclick"!==i.trigger||("row"===i.mode?y.handleActived(s,o):y.scrollToRow(s.row,s.column).then(function(){return y.handleSelected(s,o)})):y.scrollToRow(s.row,s.column).then(function(){return y.handleSelected(s,o)}))},moveCurrentRow:function(e,t,o){var l,n,r=f.treeConfig,c=k.currentRow,a=H.afterFullData,u=s.value;o.preventDefault(),c?r?(u=(r=_xeUtils.default.findTree(a,function(e){return e===c},u)).index,r=r.items,e&&0<u?l=r[u-1]:t&&u<r.length-1&&(l=r[u+1])):(r=y.getVTRowIndex(c),e&&0<r?l=a[r-1]:t&&r<a.length-1&&(l=a[r+1])):l=a[0],l&&(n={$table:y,row:l,rowIndex:y.getRowIndex(l),$rowIndex:y.getVMRowIndex(l)},y.scrollToRow(l).then(function(){return y.triggerCurrentRowEvent(o,n)}))},moveSelected:function(e,t,o,l,n,r){var c=H.afterFullData,a=H.visibleColumn,u=Object.assign({},e),e=y.getVTRowIndex(u.row),i=y.getVTColumnIndex(u.column);r.preventDefault(),o&&0<e?(u.rowIndex=e-1,u.row=c[u.rowIndex]):n&&e<c.length-1?(u.rowIndex=e+1,u.row=c[u.rowIndex]):t&&i?(u.columnIndex=i-1,u.column=a[u.columnIndex]):l&&i<a.length-1&&(u.columnIndex=i+1,u.column=a[u.columnIndex]),y.scrollToRow(u.row,u.column).then(function(){u.cell=y.getCell(u.row,u.column),y.handleSelected(u,r)})},triggerHeaderCellMousedownEvent:function(e,t){var o,l=f.mouseConfig,n=i.value;l&&n.area&&y.handleHeaderCellAreaEvent&&(l=e.currentTarget,n=(0,_dom.getEventTargetNode)(e,l,"vxe-cell--sort").flag,o=(0,_dom.getEventTargetNode)(e,l,"vxe-cell--filter").flag,y.handleHeaderCellAreaEvent(e,Object.assign({cell:l,triggerSort:n,triggerFilter:o},t))),y.focus(),y.closeMenu&&y.closeMenu()},triggerCellMousedownEvent:function(e,t){var o=e.currentTarget;t.cell=o,function(e,t){var o=f.editConfig,l=f.checkboxConfig,n=f.mouseConfig,r=u.value,c=i.value,a=g.value;if(n&&c.area&&y.handleCellAreaEvent)return y.handleCellAreaEvent(e,t);l&&r.range&&d(e,t),n&&c.selected&&(o&&"cell"!==a.mode||y.handleSelected(t,e))}(e,t),y.focus(),y.closeFilter(),y.closeMenu&&y.closeMenu()}}}},_default=tableKeyboardHook;exports.default=_default;