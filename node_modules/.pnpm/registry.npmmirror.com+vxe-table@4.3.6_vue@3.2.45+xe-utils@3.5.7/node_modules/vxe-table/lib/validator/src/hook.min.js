"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_xeUtils=_interopRequireDefault(require("xe-utils")),_utils=require("../../tools/utils"),_dom=require("../../tools/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,r=1,l=arguments.length;r<l;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},Rule=function(){function e(e){Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.max,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return Object.defineProperty(e.prototype,"content",{get:function(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"message",{get:function(){return this.content},enumerable:!1,configurable:!0}),e}(),tableValidatorMethodKeys=["fullValidate","validate","clearValidate"],validatorHook={setupTable:function(f){function r(e,u,l){var t,n,a={},i=v.editRules,s=v.treeConfig,c=m.afterFullData,r=x.value,d=_.value,o=(!0===e?t=c:e&&(_xeUtils.default.isFunction(e)?u=e:t=_xeUtils.default.isArray(e)?e:[e]),t=t||(f.getInsertRecords?f.getInsertRecords().concat(f.getUpdateRecords()):[]),[]);return m._lastCallTime=Date.now(),g=!1,w.clearValidate(),i?(n=f.getColumns(),e=function(r){var e;!l&&g||(e=[],n.forEach(function(t){!l&&g||!_xeUtils.default.has(i,t.property)||e.push(y.validCellRules("all",r,t).catch(function(e){e={rule:e.rule,rules:e.rules,rowIndex:f.getRowIndex(r),row:r,columnIndex:f.getColumnIndex(t),column:t,field:t.property,$table:f};if(a[t.property]||(a[t.property]=[]),a[t.property].push(e),!l)return g=!0,Promise.reject(e)}))}),o.push(Promise.all(e)))},s?_xeUtils.default.eachTree(t,e,r):t.forEach(e),Promise.all(o).then(function(){var e=Object.keys(a);return(0,_vue.nextTick)().then(function(){if(e.length)return Promise.reject(a[e[0]][0]);u&&u()})}).catch(function(o){return new Promise(function(e,t){function r(){var t;o.cell=f.getCell(o.row,o.column),(0,_dom.scrollToView)(o.cell),t=o,new Promise(function(e){!1===_.value.autoPos?(f.dispatchEvent("valid-error",t,null),e()):f.handleActived(t,{type:"valid-error",trigger:"call"}).then(function(){setTimeout(function(){e(y.showValidTooltip(t))},10)})}).then(l)}var l=function(){(0,_vue.nextTick)(function(){u?(u(a),e()):("obsolete"===_conf.default.validToReject?t:e)(a)})},n=o.row,i=c.indexOf(n),i=0<i?c[i-1]:n;!1===d.autoPos?l():(s?f.scrollToTreeRow(i):f.scrollToRow(i)).then(r)})})):(0,_vue.nextTick)().then(function(){u&&u()})}function p(e,t){var r=e.type,l=e.min,n=e.max,e=e.pattern,i=(r="number"===r)?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!r||!isNaN(t))||!_xeUtils.default.eqNull(l)&&i<_xeUtils.default.toNumber(l)||!_xeUtils.default.eqNull(n)&&i>_xeUtils.default.toNumber(n)||!(!e||(_xeUtils.default.isRegExp(e)?e:new RegExp(e)).test(t))}var g,v=f.props,d=f.reactData,m=f.internalData,h=f.getRefMaps().refValidTooltip,e=f.getComputeMaps(),_=e.computeValidOpts,x=e.computeTreeOpts,s=e.computeEditOpts,w={},y={},y={validCellRules:function(i,o,u,e){var a,s,t=v.editRules,r=u.property,c=[],d=[];return r&&t&&(a=_xeUtils.default.get(t,r))&&(s=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(o,r):e,a.forEach(function(t){var e,r=t.type,l=t.trigger,n=t.required;"all"!==i&&l&&i!==l||(_xeUtils.default.isFunction(t.validator)?(e=t.validator({cellValue:s,rule:t,rules:a,row:o,rowIndex:f.getRowIndex(o),column:u,columnIndex:f.getColumnIndex(u),field:u.property,$table:f}))&&(_xeUtils.default.isError(e)?(g=!0,c.push(new Rule({type:"custom",trigger:l,content:e.message,rule:new Rule(t)}))):e.catch&&d.push(e.catch(function(e){g=!0,c.push(new Rule({type:"custom",trigger:l,content:e&&e.message?e.message:t.content||t.message,rule:new Rule(t)}))}))):(e="array"===r||_xeUtils.default.isArray(s)?!_xeUtils.default.isArray(s)||!s.length:(0,_utils.eqEmptyValue)(s),(n?e||p(t,s):!e&&p(t,s))&&(g=!0,c.push(new Rule(t)))))})),Promise.all(d).then(function(){if(c.length)return Promise.reject({rules:c,rule:c[0]})})},hasCellRules:function(t,e,r){var l=v.editRules,r=r.property;return!(!r||!l)&&(l=_xeUtils.default.get(l,r))&&!!_xeUtils.default.find(l,function(e){return"all"===t||!e.trigger||t===e.trigger})},triggerValidate:function(t){var e=v.editConfig,r=v.editRules,l=d.editStore,n=d.validStore,l=l.actived,i=s.value;if(e&&r&&l.row){var e=l.args,o=e.row,u=e.column,a=e.cell;if(y.hasCellRules(t,o,u))return y.validCellRules(t,o,u).then(function(){"row"===i.mode&&n.visible&&n.row===o&&n.column===u&&w.clearValidate()}).catch(function(e){var e=e.rule;return e.trigger&&t!==e.trigger?Promise.resolve():(y.showValidTooltip(e={rule:e,row:o,column:u,cell:a}),Promise.reject(e))})}return Promise.resolve()},showValidTooltip:function(e){var t=v.height,r=d.tableData,l=d.validStore,n=_.value,i=e.rule,o=e.row,u=e.column,a=e.cell,s=h.value,c=i.content;return(0,_vue.nextTick)().then(function(){if(Object.assign(l,{row:o,column:u,rule:i,content:c,visible:!0}),f.dispatchEvent("valid-error",e,null),s&&("tooltip"===n.message||"default"===n.message&&!t&&r.length<2))return s.open(a,c)})}};return __assign(__assign({},w={fullValidate:function(e,t){return r(e,t,!0)},validate:function(e,t){return r(e,t)},clearValidate:function(){var e=d.validStore,t=h.value;return Object.assign(e,{visible:!1,row:null,column:null,content:"",rule:null}),t&&t.reactData.visible&&t.close(),(0,_vue.nextTick)()}}),y)},setupGrid:function(e){return e.extendTableMethods(tableValidatorMethodKeys)}},_default=validatorHook;exports.default=_default;