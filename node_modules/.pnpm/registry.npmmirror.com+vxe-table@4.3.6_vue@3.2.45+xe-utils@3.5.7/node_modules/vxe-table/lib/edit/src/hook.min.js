"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=require("../../v-x-e-table"),_utils=require("../../tools/utils"),_util=require("../../table/src/util"),_dom=require("../../tools/dom"),_log=require("../../tools/log");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,r=1,l=arguments.length;r<l;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},__spreadArray=function(e,t,r){if(r||2===arguments.length)for(var l,n=0,o=t.length;n<o;n++)!l&&n in t||((l=l||Array.prototype.slice.call(t,0,n))[n]=t[n]);return e.concat(l||Array.prototype.slice.call(t))},tableEditMethodKeys=["insert","insertAt","remove","removeCheckboxRow","removeRadioRow","removeCurrentRow","getRecordset","getInsertRecords","getRemoveRecords","getUpdateRecords","getEditRecord","getActiveRecord","getSelectedCell","clearEdit","clearActived","clearSelected","isEditByRow","isActiveByRow","setEditRow","setActiveRow","setEditCell","setActiveCell","setSelectCell"],editHook={setupTable:function(x){function f(e,t){var r=t.model;t.editRender&&(r.value=(0,_util.getCellValue)(e,t),r.update=!1)}function n(e,t){var r=t.model;t.editRender&&r.update&&((0,_util.setCellValue)(e,t,r.value),r.update=!1,r.value=null)}function r(){var e=o.value;e&&(e=e.querySelector(".col--selected"))&&(0,_dom.removeClass)(e,"col--selected")}var _=x.props,C=x.reactData,E=x.internalData,o=x.getRefMaps().refElem,e=x.getComputeMaps(),c=e.computeMouseOpts,v=e.computeEditOpts,w=e.computeCheckboxOpts,b=e.computeTreeOpts,g={},p={};function a(){var e=C.editStore,t=C.tableColumn,r=v.value,e=e.actived,l=e.row,e=e.column;(l||e)&&("row"===r.mode?t.forEach(function(e){return n(l,e)}):n(l,e))}function I(e,t){var a=E.tableFullTreeData,i=E.afterFullData,u=E.fullDataRowIdData,c=E.fullAllDataRowIdData,r=b.value,d=r.rowField,s=r.parentField,f=r.children,v=r.mapChildren,p=t?"push":"unshift";e.forEach(function(e){var t,r,l=e[s],n=(0,_util.getRowid)(x,e),o=l?_xeUtils.default.findTree(a,function(e){return l===e[d]},{children:v}):null;o=o?(o=o.item,t=(t=c[(0,_util.getRowid)(x,o)])?t.level:0,r=o[f],(r=_xeUtils.default.isArray(r)?r:o[f]=[])[p](e),{row:e,rowid:n,seq:-1,index:-1,_index:-1,$index:-1,items:r,parent:parent,level:t+1}):("development"===process.env.NODE_ENV&&l&&(0,_log.warnLog)("vxe.error.unableInsert"),i[p](e),a[p](e),{row:e,rowid:n,seq:-1,index:-1,_index:-1,$index:-1,items:a,parent:null,level:0}),u[n]=o,c[n]=o})}return p={handleActived:function(e,t){var r=_.editConfig,l=_.mouseConfig,n=C.editStore,o=C.tableColumn,a=v.value,i=a.mode,n=n.actived,u=e.row,c=e.column,d=c.editRender,s=e.cell||x.getCell(u,c),a=a.beforeEditMethod||a.activeMethod;return e.cell=s,(0,_utils.isEnableConf)(r)&&(0,_utils.isEnableConf)(d)&&s&&(n.row!==u||"cell"===i&&n.column!==c?(r="edit-disabled",a&&!a(__assign(__assign({},e),{$table:x}))||(l&&(g.clearSelected(),x.clearCellAreas)&&(x.clearCellAreas(),x.clearCopyCellArea()),x.closeTooltip(),n.column&&g.clearEdit(t),r="edit-actived",c.renderHeight=s.offsetHeight,n.args=e,n.row=u,n.column=c,"row"===i?o.forEach(function(e){return f(u,e)}):f(u,c),(0,_vue.nextTick)(function(){p.handleFocus(e,t)})),x.dispatchEvent(r,{row:u,rowIndex:x.getRowIndex(u),$rowIndex:x.getVMRowIndex(u),column:c,columnIndex:x.getColumnIndex(c),$columnIndex:x.getVMColumnIndex(c)},t)):(d=n.column,l&&(g.clearSelected(),x.clearCellAreas)&&(x.clearCellAreas(),x.clearCopyCellArea()),d!==c&&((a=d.model).update&&(0,_util.setCellValue)(u,d,a.value),x.clearValidate)&&x.clearValidate(),c.renderHeight=s.offsetHeight,n.args=e,n.column=c,setTimeout(function(){p.handleFocus(e,t)})),x.focus()),(0,_vue.nextTick)()},handleFocus:function(e){var t,r,l,n=e.row,o=e.column,a=e.cell,i=o.editRender;(0,_utils.isEnableConf)(i)&&(l=_vXETable.renderer.get(i.name),t=i.autofocus,i=i.autoselect,r=void 0,!t&&l&&(t=l.autofocus),!i&&l&&(i=l.autoselect),_xeUtils.default.isFunction(t)?r=t.call(this,e):t&&(r=a.querySelector(t))&&r.focus(),r?i?r.select():_dom.browse.msie&&((l=r.createTextRange()).collapse(!1),l.select()):x.scrollToRow(n,o))},handleSelected:function(e,t){var r=_.mouseConfig,l=C.editStore,n=c.value,o=v.value,a=l.actived,l=l.selected,i=e.row,u=e.column,r=r&&n.selected;return!r||l.row===i&&l.column===u||(a.row!==i||"cell"===o.mode&&a.column!==u)&&(g.clearEdit(t),g.clearSelected(),x.clearCellAreas&&(x.clearCellAreas(),x.clearCopyCellArea()),l.args=e,l.row=i,l.column=u,r&&p.addCellSelectedClass(),x.focus(),t)&&x.dispatchEvent("cell-selected",e,t),(0,_vue.nextTick)()},addCellSelectedClass:function(){var e=C.editStore.selected,t=e.row,e=e.column;r(),t&&e&&(t=x.getCell(t,e))&&(0,_dom.addClass)(t,"col--selected")}},__assign(__assign({},g={insert:function(e){return g.insertAt(e,null)},insertAt:function(e,t){var r=_.treeConfig,l=C.mergeList,n=C.editStore,o=E.tableFullTreeData,a=E.afterFullData,i=E.tableFullData,u=E.fullDataRowIdData,c=E.fullAllDataRowIdData,d=b.value,s=d.transform,f=d.rowField,v=d.mapChildren,p=(e=_xeUtils.default.isArray(e)?e:[e]).map(function(e){return x.defineField(Object.assign({},e))});if(t)if(-1===t)r&&s?I(p,!0):(a.push.apply(a,p),i.push.apply(i,p),l.forEach(function(e){var t=e.row,r=e.rowspan;t+r>a.length&&(e.rowspan=r+p.length)}));else if(r&&s){var w,g,m,h=_xeUtils.default.findTree(o,function(e){return t[f]===e[f]},{children:v});h?(w=h.parent,g=h.items,e=c[(0,_util.getRowid)(x,w)],m=e?e.level:0,p.forEach(function(e,t){var r=(0,_util.getRowid)(x,e),t=("development"===process.env.NODE_ENV&&e[d.parentField]&&w&&e[d.parentField]!==w[f]&&(0,_log.errLog)("vxe.error.errProp",["".concat(d.parentField,"=").concat(e[d.parentField]),"".concat(d.parentField,"=").concat(w[f])]),w&&(e[d.parentField]=w[f]),g.splice(h.index+t,0,e),{row:e,rowid:r,seq:-1,index:-1,_index:-1,$index:-1,items:g,parent:w,level:m+1});u[r]=t,c[r]=t})):("development"===process.env.NODE_ENV&&(0,_log.warnLog)("vxe.error.unableInsert"),I(p,!0))}else{if(r)throw new Error((0,_log.getLog)("vxe.error.noTree",["insert"]));var R=-1;if(_xeUtils.default.isNumber(t)?t<a.length&&(R=t):R=x.findRowIndexOf(a,t),-1===R)throw new Error((0,_log.errLog)("vxe.error.unableInsert"));a.splice.apply(a,__spreadArray([R,0],p,!1)),i.splice.apply(i,__spreadArray([x.findRowIndexOf(i,t),0],p,!1)),l.forEach(function(e){var t=e.row,r=e.rowspan;R<t?e.row=t+p.length:R<t+r&&(e.rowspan=r+p.length)})}else r&&s?I(p,!1):(a.unshift.apply(a,p),i.unshift.apply(i,p),l.forEach(function(e){var t=e.row;0<t&&(e.row=t+p.length)}));return(o=n.insertList).unshift.apply(o,p),x.updateFooter(),x.cacheRowMap(),x.handleTableData(r&&s),r&&s||x.updateAfterDataIndex(),x.checkSelectionStatus(),C.scrollYLoad&&x.updateScrollYSpace(),(0,_vue.nextTick)().then(function(){return x.updateCellAreas(),x.recalculate()}).then(function(){return{row:p.length?p[p.length-1]:null,rows:p}})},remove:function(e){var t=_.treeConfig,r=C.mergeList,l=C.editStore,n=C.selection,o=E.tableFullTreeData,a=E.afterFullData,i=E.tableFullData,u=w.value,c=b.value,d=c.transform,s=l.actived,f=l.removeList,v=l.insertList,l=u.checkField,p=[];return e?_xeUtils.default.isArray(e)||(e=[e]):e=i,e.forEach(function(e){x.isInsertByRow(e)||f.push(e)}),l||e.forEach(function(e){e=x.findRowIndexOf(n,e);-1<e&&n.splice(e,1)}),i===e?(e=p=i.slice(0),E.tableFullData=[],E.afterFullData=[],x.clearMergeCells()):t&&d?e.forEach(function(e){var t=(0,_util.getRowid)(x,e),r=_xeUtils.default.findTree(o,function(e){return t===(0,_util.getRowid)(x,e)},c),r=(r&&(r=r.items.splice(r.index,1),p.push(r[0])),x.findRowIndexOf(a,e));-1<r&&a.splice(r,1)}):e.forEach(function(e){var t=x.findRowIndexOf(i,e),l=(-1<t&&(t=i.splice(t,1),p.push(t[0])),x.findRowIndexOf(a,e));-1<l&&(r.forEach(function(e){var t=e.row,r=e.rowspan;l<t?e.row=t-1:l<t+r&&(e.rowspan=r-1)}),a.splice(l,1))}),s.row&&-1<x.findRowIndexOf(e,s.row)&&g.clearEdit(),e.forEach(function(e){e=x.findRowIndexOf(v,e);-1<e&&v.splice(e,1)}),x.updateFooter(),x.cacheRowMap(),x.handleTableData(t&&d),t&&d||x.updateAfterDataIndex(),x.checkSelectionStatus(),C.scrollYLoad&&x.updateScrollYSpace(),(0,_vue.nextTick)().then(function(){return x.updateCellAreas(),x.recalculate()}).then(function(){return{row:p.length?p[p.length-1]:null,rows:p}})},removeCheckboxRow:function(){return g.remove(x.getCheckboxRecords()).then(function(e){return x.clearCheckboxRow(),e})},removeRadioRow:function(){var e=x.getRadioRecord();return g.remove(e||[]).then(function(e){return x.clearRadioRow(),e})},removeCurrentRow:function(){var e=x.getCurrentRecord();return g.remove(e||[]).then(function(e){return x.clearCurrentRow(),e})},getRecordset:function(){return{insertRecords:g.getInsertRecords(),removeRecords:g.getRemoveRecords(),updateRecords:g.getUpdateRecords()}},getInsertRecords:function(){var e=_.treeConfig,t=C.editStore,r=E.tableFullTreeData,l=E.tableFullData,n=b.value,t=t.insertList,o=[];return t.length&&(e&&n.transform?t.forEach(function(e){var t=(0,_util.getRowid)(x,e);_xeUtils.default.findTree(r,function(e){return t===(0,_util.getRowid)(x,e)},n)&&o.push(e)}):t.forEach(function(e){-1<x.findRowIndexOf(l,e)&&o.push(e)})),o},getRemoveRecords:function(){return C.editStore.removeList},getUpdateRecords:function(){var e=_.keepSource,t=_.treeConfig,r=E.tableFullData,l=b.value;return e?(a(),t?_xeUtils.default.filterTree(r,function(e){return x.isUpdateByRow(e)},l):r.filter(function(e){return x.isUpdateByRow(e)})):[]},getActiveRecord:function(){return this.getEditRecord()},getEditRecord:function(){var e=C.editStore,t=E.afterFullData,r=o.value,e=e.actived,l=e.args,e=e.row;return l&&-1<x.findRowIndexOf(t,e)&&r.querySelectorAll(".vxe-body--column.col--actived").length?Object.assign({},l):null},getSelectedCell:function(){var e=C.editStore.selected,t=e.args,e=e.column;return t&&e?Object.assign({},t):null},clearActived:function(e){return this.clearEdit(e)},clearEdit:function(e){var t=C.editStore.actived,r=t.row,l=t.column;return(r||l)&&(a(),t.args=null,t.row=null,t.column=null,x.updateFooter(),x.dispatchEvent("edit-closed",{row:r,rowIndex:x.getRowIndex(r),$rowIndex:x.getVMRowIndex(r),column:l,columnIndex:x.getColumnIndex(l),$columnIndex:x.getVMColumnIndex(l)},e||null)),x.clearValidate?x.clearValidate():(0,_vue.nextTick)()},clearSelected:function(){var e=C.editStore.selected;return e.row=null,e.column=null,r(),(0,_vue.nextTick)()},isActiveByRow:function(e){return this.isEditByRow(e)},isEditByRow:function(e){return C.editStore.actived.row===e},setActiveRow:function(e){return g.setEditRow(e)},setEditRow:function(e){var t=E.visibleColumn;return x.setEditCell(e,_xeUtils.default.find(t,function(e){return(0,_utils.isEnableConf)(e.editRender)}))},setActiveCell:function(e,t){return g.setEditCell(e,t)},setEditCell:function(t,e){var r=_.editConfig,l=_xeUtils.default.isString(e)?x.getColumnByField(e):e;return t&&l&&(0,_utils.isEnableConf)(r)&&(0,_utils.isEnableConf)(l.editRender)?x.scrollToRow(t,l).then(function(){var e=x.getCell(t,l);return e&&(p.handleActived({row:t,rowIndex:x.getRowIndex(t),column:l,columnIndex:x.getColumnIndex(l),cell:e,$table:x}),E._lastCallTime=Date.now()),(0,_vue.nextTick)()}):(0,_vue.nextTick)()},setSelectCell:function(e,t){var r=C.tableData,l=v.value,t=_xeUtils.default.isString(t)?x.getColumnByField(t):t;return e&&t&&"manual"!==l.trigger&&-1<(l=x.findRowIndexOf(r,e))&&t&&(r=x.getCell(e,t),e={row:e,rowIndex:l,column:t,columnIndex:x.getColumnIndex(t),cell:r},x.handleSelected(e,{})),(0,_vue.nextTick)()}}),p)},setupGrid:function(e){return e.extendTableMethods(tableEditMethodKeys)}},_default=editHook;exports.default=_default;